<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Big+Shoulders:opsz,wght@10..72,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <title>Nike Customer Order</title>
    <link rel="stylesheet" href="index.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  </head>
  <body>
    <header>
      <h1>Customer Order</h1>
      <button
        id="themeToggle"
        style="position: absolute; top: 20px; right: 20px"
      >
        ðŸŒ™
      </button>
    </header>
    <div class="search-container">
      <div>
        <label for="search">Search Orders:</label>
        <input
          type="text"
          id="search"
          onkeyup="searchOrders()"
          placeholder="Search orders..."
        />
      </div>
      <a href="add_order.html" class="add-order-button">Add Order</a>
    </div>

    <div class="table-container">
      <h2>Orders List</h2>
      <table id="ordersTable">
        <thead>
          <tr>
            <th class="order-id">Order ID</th>
            <th>Order Date</th>
            <th>Customer Name</th>
            <th>Phone Number</th>
            <th>Item Number</th>
            <th>Color</th>
            <th>Size</th>
            <th>Description</th>
            <th>Branch</th>
            <th>Employee</th>
            <th>Entered By</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="ordersPagination">
        <button id="prevOrdersBtn" onclick="changeOrdersPage(-1)">
          Previous
        </button>
        <span id="ordersPageNumbers"></span>
        <button id="nextOrdersBtn" onclick="changeOrdersPage(1)">Next</button>
      </div>
    </div>

    <div class="search-container">
      <div>
        <label for="arrivalSearch">Search Arrival Table:</label>
        <input
          type="text"
          id="arrivalSearch"
          onkeyup="searchArrivalTable()"
          placeholder="Search by Name or Phone Number"
        />
      </div>
    </div>

    <div class="table-container">
      <h2>Phone Numbers, Name & Date of Arrival</h2>
      <table id="arrivalTable">
        <thead>
          <tr>
            <th class="order-id">Order ID</th>
            <th>Name</th>
            <th>Phone Number</th>
            <th>Date of Arrival</th>
            <th>SMS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="arrivalPagination">
        <button id="prevArrivalBtn" onclick="changeArrivalPage(-1)">
          Previous
        </button>
        <span id="arrivalPageNumbers"></span>
        <button id="nextArrivalBtn" onclick="changeArrivalPage(1)">Next</button>
      </div>
    </div>

    <script>
      const rowsPerPage = 30;
      let currentOrdersPage = 1;
      let currentArrivalPage = 1;
      let orders = JSON.parse(localStorage.getItem("orders")) || [];

      // âœ… Ensure each order has a unique ID (fixes duplicates and missing)
      const existingIds = new Set();
      orders.forEach((order) => {
        if (!order.id) {
          order.id = Date.now() + Math.floor(Math.random() * 1000);
        }
        while (existingIds.has(order.id)) {
          order.id = Date.now() + Math.floor(Math.random() * 1000);
        }
        existingIds.add(order.id);
      });

      localStorage.setItem("orders", JSON.stringify(orders));

      function loadOrders() {
        const ordersTableBody = document
          .getElementById("ordersTable")
          .getElementsByTagName("tbody")[0];
        ordersTableBody.innerHTML = "";

        // Sort orders by Order Date (newest first)
        orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

        const totalOrdersPages = Math.ceil(orders.length / rowsPerPage);
        const ordersStartIndex = (currentOrdersPage - 1) * rowsPerPage;
        const ordersEndIndex = Math.min(
          ordersStartIndex + rowsPerPage,
          orders.length
        );

        for (let i = ordersStartIndex; i < ordersEndIndex; i++) {
          const order = orders[i];
          const statusClass =
            order.status === "Arrived" ? "arrived" : "pending";

          const row = ordersTableBody.insertRow();
          row.setAttribute("data-id", order.id);
          row.innerHTML = `
          <td class="order-id">${order.id || "N/A"}</td>
          <td>${order.orderDate || "N/A"}</td>
          <td>${order.customerName || "N/A"}</td>
          <td>${order.phoneNumber || "N/A"}</td>
          <td>${order.itemNumber || "N/A"}</td>
          <td>${order.color || "N/A"}</td>
          <td>${order.size || "N/A"}</td>
          <td>${order.description || "N/A"}</td>
          <td>${order.branch || "N/A"}</td>
          <td>${order.employee || "N/A"}</td>
          <td>${order.enteredBy || "N/A"}</td>
          <td><button class="status-button ${statusClass}" onclick="toggleStatus(this, '${
            order.id
          }')">${order.status}</button></td>
          <td>
            <button onclick="editOrderById('${order.id}')">Edit</button>
            <button onclick="deleteOrder('${order.id}')">Delete</button>
          </td>`;
          updateRowColor(row, order);
        }

        document.getElementById("prevOrdersBtn").disabled =
          currentOrdersPage === 1;
        document.getElementById("nextOrdersBtn").disabled =
          currentOrdersPage === totalOrdersPages;

        const ordersPageNumbers = document.getElementById("ordersPageNumbers");
        ordersPageNumbers.innerHTML = "";
        for (let page = 1; page <= totalOrdersPages; page++) {
          const pageButton = document.createElement("button");
          pageButton.innerText = page;
          pageButton.onclick = () => goToOrdersPage(page);
          if (page === currentOrdersPage) {
            pageButton.disabled = true;
          }
          ordersPageNumbers.appendChild(pageButton);
        }

        loadArrivalTable();
      }

      function loadArrivalTable() {
        const arrivalTableBody = document
          .getElementById("arrivalTable")
          .getElementsByTagName("tbody")[0];
        arrivalTableBody.innerHTML = "";

        const arrivedOrders = orders
          .filter((order) => order.status === "Arrived")
          .sort((a, b) => new Date(b.arrivalDate) - new Date(a.arrivalDate));
        const totalArrivalPages = Math.ceil(arrivedOrders.length / rowsPerPage);
        const arrivalStartIndex = (currentArrivalPage - 1) * rowsPerPage;
        const arrivalEndIndex = Math.min(
          arrivalStartIndex + rowsPerPage,
          arrivedOrders.length
        );

        for (let i = arrivalStartIndex; i < arrivalEndIndex; i++) {
          const order = arrivedOrders[i];
          if (order.smsSent === undefined) {
            order.smsSent = false;
          }
          const arrivalDate = order.arrivalDate
            ? new Date(order.arrivalDate).toLocaleString()
            : new Date().toLocaleString();
          const row = arrivalTableBody.insertRow();
          row.innerHTML = `
          <td class="order-id">${order.id || "N/A"}</td>
          <td>${order.customerName || "N/A"}</td>
          <td>${order.phoneNumber || "N/A"}</td>
          <td contenteditable="true" onblur="updateArrivalDate('${
            order.id
          }', this)">${arrivalDate}</td>
          <td>
            <button onclick="sendSms('${
              order.id
            }', this)" style="background-color: ${
            order.smsSent ? "green" : "orange"
          };">
              ${order.smsSent ? "SMS Sent" : "Send SMS"}
            </button>
          </td>`;
        }

        document.getElementById("prevArrivalBtn").disabled =
          currentArrivalPage === 1;
        document.getElementById("nextArrivalBtn").disabled =
          currentArrivalPage === totalArrivalPages;

        const arrivalPageNumbers =
          document.getElementById("arrivalPageNumbers");
        arrivalPageNumbers.innerHTML = "";
        for (let page = 1; page <= totalArrivalPages; page++) {
          const pageButton = document.createElement("button");
          pageButton.innerText = page;
          pageButton.onclick = () => goToArrivalPage(page);
          if (page === currentArrivalPage) {
            pageButton.disabled = true;
          }
          arrivalPageNumbers.appendChild(pageButton);
        }
      }

      function updateRowColor(row, order) {
        const statusButton = row.querySelector(".status-button");
        statusButton.style.backgroundColor =
          order.status === "Arrived" ? "green" : "blue";
      }

      function toggleStatus(button, id) {
        const currentStatus = button.innerText;
        const order = orders.find((o) => o.id == id);
        if (!order) return;
        if (currentStatus === "Pending") {
          button.innerText = "Arrived";
          button.style.backgroundColor = "green";
          order.status = "Arrived";
          order.arrivalDate = new Date().toISOString();
          if (order.smsSent === undefined) {
            order.smsSent = false;
          }
        } else {
          button.innerText = "Pending";
          button.style.backgroundColor = "blue";
          order.status = "Pending";
          order.arrivalDate = ""; // <--- reset arrival date when status is reverted
        }
        localStorage.setItem("orders", JSON.stringify(orders));
        loadOrders();
        exportToExcel();
      }

      function updateArrivalDate(id, cell) {
        const order = orders.find((o) => o.id == id);
        if (!order) return;
        order.arrivalDate = cell.innerText;
        localStorage.setItem("orders", JSON.stringify(orders));
        loadArrivalTable();
        exportToExcel();
      }

      function sendSms(id, button) {
        const order = orders.find((o) => o.id == id);
        if (!order) return;
        const phoneNumber = order.phoneNumber;
        const customerName = order.customerName;
        const itemNumber = order.itemNumber;
        const color = order.color;

        if (button.innerText === "SMS Sent") {
          if (confirm("Do you want to reset the SMS status to 'Send SMS'?")) {
            button.innerText = "Send SMS";
            button.style.backgroundColor = "orange";
            order.smsSent = false;
            localStorage.setItem("orders", JSON.stringify(orders));
            exportToExcel();
          }
          return;
        }

        if (!phoneNumber) {
          alert("No phone number provided.");
          return;
        }

        let cleanedNumber = phoneNumber.replace(/\D/g, "");
        if (cleanedNumber.startsWith("0")) {
          cleanedNumber = "961" + cleanedNumber.slice(1);
        } else if (!cleanedNumber.startsWith("961")) {
          cleanedNumber = "961" + cleanedNumber;
        }

        const googleSearchLink = `https://www.google.com/search?q=${encodeURIComponent(
          itemNumber + " " + color
        )}`;
        const message = encodeURIComponent(
          `Dear ${customerName},\n\nYour Nike order has arrived at our ABC Dbayeh branch and is now ready for collection. We will hold your order for 2 days only.\n\nYou can explore more on our website: https://sidewalks.net\n\nThis is a system-generated message. Please do not reply. For any inquiries, kindly contact us directly by phone.`
        );
        const whatsappUrl = `https://web.whatsapp.com/send?phone=${cleanedNumber}&text=${message}`;
        window.open(whatsappUrl, "_blank");

        order.smsSent = true;
        localStorage.setItem("orders", JSON.stringify(orders));
        exportToExcel();

        button.innerText = "SMS Sent";
        button.style.backgroundColor = "green";
      }

      function searchOrders() {
        const input = document.getElementById("search");
        const filter = input.value.toLowerCase();
        const pagination = document.getElementById("ordersPagination");

        const ordersTableBody = document
          .getElementById("ordersTable")
          .getElementsByTagName("tbody")[0];

        if (filter === "") {
          pagination.style.display = "flex";
          loadOrders(); // reload all paginated orders
          return;
        }

        pagination.style.display = "none"; // hide pagination during search
        ordersTableBody.innerHTML = ""; // clear current table

        const filteredOrders = orders.filter((order) => {
          return Object.values(order).some((value) =>
            String(value).toLowerCase().includes(filter)
          );
        });

        filteredOrders.forEach((order) => {
          const statusClass =
            order.status === "Arrived" ? "arrived" : "pending";
          const row = ordersTableBody.insertRow();
          row.setAttribute("data-id", order.id);
          row.innerHTML = `
      <td class="order-id">${order.id || "N/A"}</td>
      <td>${order.orderDate || "N/A"}</td>
      <td>${order.customerName || "N/A"}</td>
      <td>${order.phoneNumber || "N/A"}</td>
      <td>${order.itemNumber || "N/A"}</td>
      <td>${order.color || "N/A"}</td>
      <td>${order.size || "N/A"}</td>
      <td>${order.description || "N/A"}</td>
      <td>${order.branch || "N/A"}</td>
      <td>${order.employee || "N/A"}</td>
      <td>${order.enteredBy || "N/A"}</td>
      <td><button class="status-button ${statusClass}" onclick="toggleStatus(this, '${
            order.id
          }')">${order.status}</button></td>
      <td>
        <button onclick="editOrderById('${order.id}')">Edit</button>
        <button onclick="deleteOrder('${order.id}')">Delete</button>
      </td>
    `;
          updateRowColor(row, order);
        });
      }

      function searchArrivalTable() {
        const filter = document
          .getElementById("arrivalSearch")
          .value.toLowerCase();
        const rows = document
          .getElementById("arrivalTable")
          .getElementsByTagName("tbody")[0]
          .getElementsByTagName("tr");
        for (let i = 0; i < rows.length; i++) {
          const nameCell = rows[i].cells[1].innerText.toLowerCase();
          const phoneCell = rows[i].cells[2].innerText.toLowerCase();
          rows[i].style.display =
            nameCell.includes(filter) || phoneCell.includes(filter)
              ? ""
              : "none";
        }
      }

      function deleteOrder(id) {
        if (confirm("Are you sure you want to delete this order?")) {
          const index = orders.findIndex((o) => o.id == id);
          if (index !== -1) {
            orders.splice(index, 1);
            localStorage.setItem("orders", JSON.stringify(orders));
            loadOrders();
            exportToExcel();
          }
        }
      }

      function editOrderById(id) {
        localStorage.setItem("editOrderId", id);
        window.location.href = "edit_order.html";
      }

      function changeOrdersPage(direction) {
        currentOrdersPage += direction;
        loadOrders();
      }

      function changeArrivalPage(direction) {
        currentArrivalPage += direction;
        loadArrivalTable();
      }

      function goToOrdersPage(pageNumber) {
        currentOrdersPage = pageNumber;
        loadOrders();
      }

      function goToArrivalPage(pageNumber) {
        currentArrivalPage = pageNumber;
        loadArrivalTable();
      }

      function exportToExcel() {
        const fullOrders = orders.map((order) => ({
          id: order.id || "",
          orderDate: order.orderDate || "",
          customerName: order.customerName || "",
          phoneNumber: order.phoneNumber || "",
          itemNumber: order.itemNumber || "",
          color: order.color || "",
          size: order.size || "",
          description: order.description || "",
          branch: order.branch || "",
          employee: order.employee || "",
          enteredBy: order.enteredBy || "",
          status: order.status || "Pending",
          arrivalDate: order.arrivalDate || "",
          smsSent: order.smsSent || false,
        }));

        const worksheet = XLSX.utils.json_to_sheet(fullOrders);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Orders");
        XLSX.writeFile(workbook, "Orders.xlsx");
      }

      window.onload = function () {
        loadOrders();

        // Apply saved theme on load
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "light") {
          document.body.classList.add("light-mode");
          document.getElementById("themeToggle").textContent = "ðŸŒž";
        }

        // Theme toggle button behavior
        document.getElementById("themeToggle").onclick = function () {
          document.body.classList.toggle("light-mode");
          const isLight = document.body.classList.contains("light-mode");
          this.textContent = isLight ? "ðŸŒž" : "ðŸŒ™";
          localStorage.setItem("theme", isLight ? "light" : "dark");
        };
      };
    </script>
  </body>
</html>
