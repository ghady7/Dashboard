<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Big+Shoulders:opsz,wght@10..72,100..900&family=Outfit:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap"
      rel="stylesheet"
    />
    <title>Edit Order</title>
    <link rel="stylesheet" href="add_order.css" />
    <style>
      body {
        background: #121212;
        color: #ffffff;
        font-family: "Poppins", sans-serif;
      }
      #confirmationPopup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        background: #1e1e1e;
        padding: 30px;
        border: 2px solid #ff6b00;
        border-radius: 10px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        width: 350px;
        text-align: center;
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      #confirmationPopup.active {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      #confirmationPopup.exiting {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
      #confirmationPopup h3 {
        margin-bottom: 20px;
        color: #ff6b00;
        font-size: 18px;
      }
      #confirmationPopup p {
        margin-bottom: 20px;
        color: #ffffff;
        font-size: 16px;
      }
      #confirmationPopup .highlight {
        color: #ff6b00;
        font-weight: bold;
      }
      #confirmButton,
      #cancelButton {
        padding: 10px 25px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      #confirmButton {
        background-color: #ff6b00;
        color: #ffffff;
      }
      #cancelButton {
        background-color: #333333;
        color: #ffffff;
      }
      #blurOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }
      #blurOverlay.active {
        display: block;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  </head>
  <body>
    <header>
      <h1>Edit Order</h1>
    </header>
    <div class="form-container">
      <h2>Update Order Details</h2>
      <form id="editOrderForm">
        <div class="form-group">
          <label for="orderDate">Order Date</label>
          <input type="date" id="orderDate" name="orderDate" required />
        </div>
        <div class="form-group">
          <label for="customerName">Customer Name</label>
          <input type="text" id="customerName" name="customerName" required />
        </div>
        <div class="form-group">
          <label for="phoneNumber">Phone Number</label>
          <input
            type="number"
            id="phoneNumber"
            name="phoneNumber"
            max="99999999"
            min="1000000"
            placeholder="Enter 8 digits value"
            required
          />
        </div>
        <div class="form-group">
          <label for="itemNumber">Item Number</label>
          <input type="text" id="itemNumber" name="itemNumber" required />
        </div>
        <div class="form-group">
          <label for="color">Color</label>
          <input type="text" id="color" name="color" required />
        </div>
        <div class="form-group">
          <label for="size">Size</label>
          <input type="text" id="size" name="size" required />
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <input type="text" id="description" name="description" required />
        </div>
        <fieldset class="form-group fieldset" style="height: 220px">
          <legend style="font-size: large; text-align: left">Branch</legend>
          <div class="branch_div">
            <div>
              <input
                type="radio"
                id="souks"
                name="branch"
                value="Souks"
                required
              />
              <label for="souks">Nike Souks</label>
            </div>
            <div>
              <input
                type="radio"
                id="abcVerdun"
                name="branch"
                value="ABC Verdun"
              />
              <label for="abcVerdun">Nike ABC Verdun</label>
            </div>
            <div>
              <input type="radio" id="abcAsh" name="branch" value="ABC Ash" />
              <label for="abcAsh">Nike ABC Ash</label>
            </div>
            <div>
              <input type="radio" id="bcc" name="branch" value="BCC" />
              <label for="bcc">Nike BCC</label>
            </div>
            <div>
              <input
                type="radio"
                id="nikedbayeh"
                name="branch"
                value="Nike Abc Dbayeh"
              />
              <label for="nikedbayeh">Nike Abc Dbayeh</label>
            </div>
          </div>
          <div class="branch_div">
            <div>
              <input type="radio" id="ghazir" name="branch" value="Ghazir" />
              <label for="ghazir">Nike Ghazir</label>
            </div>
            <div>
              <input type="radio" id="tripoli" name="branch" value="Tripoli" />
              <label for="tripoli">Nike Tripoli</label>
            </div>
            <div>
              <input type="radio" id="gs" name="branch" value="Gs" />
              <label for="gs">Nike Gs</label>
            </div>
            <div>
              <input
                type="radio"
                id="Nike Dbayeh Highway"
                name="branch"
                value="Nike Dbayeh Highway"
              />
              <label for="Nike Dbayeh Highway">Nike Dbayeh Highway</label>
            </div>
            <div>
              <input
                type="radio"
                id="Warehouse"
                name="branch"
                value="Warehouse"
              />
              <label for="Warehouse">Warehouse</label>
            </div>
          </div>
        </fieldset>
        <div class="form-group">
          <label for="employee">Employee</label>
          <input type="text" id="employee" name="employee" required />
        </div>
        <div class="form-group">
          <label for="enteredBy">Entered By</label>
          <input type="text" id="enteredBy" name="enteredBy" required />
        </div>
        <button type="submit" id="submitButton">Update Order</button>
      </form>
    </div>
    <div id="blurOverlay"></div>
    <div id="confirmationPopup">
      <h3>Confirm Order</h3>
      <p id="orderDetails"></p>
      <button id="confirmButton">Confirm</button>
      <button id="cancelButton">Cancel</button>
    </div>
    <script>
      window.onload = function () {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "light") {
          document.body.classList.add("light-mode");
          const toggle = document.getElementById("themeToggle");
          if (toggle) toggle.textContent = "ðŸŒž";
        }
        const editId = localStorage.getItem("editOrderId");
        if (!editId) {
          window.location.href = "index.html";
          return;
        }
        const savedOrders = JSON.parse(localStorage.getItem("orders")) || [];
        const order = savedOrders.find((o) => o.id == editId);
        if (!order) {
          window.location.href = "index.html";
          return;
        }
        // Populate the form with the existing order details
        document.getElementById("customerName").value = order.customerName;
        document.getElementById("phoneNumber").value = order.phoneNumber;
        document.getElementById("itemNumber").value = order.itemNumber;
        document.getElementById("color").value = order.color;
        document.getElementById("size").value = order.size;
        document.getElementById("description").value = order.description;
        document.getElementById("employee").value = order.employee;
        document.getElementById("enteredBy").value = order.enteredBy;
        document.querySelector(
          'input[name="branch"][value="' + order.branch + '"]'
        ).checked = true;
        document.getElementById("orderDate").value = order.orderDate;

        document
          .getElementById("editOrderForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const customerName = document.getElementById("customerName").value;
            const phoneNumber = document.getElementById("phoneNumber").value;

            document.getElementById("orderDetails").innerHTML =
              'Customer Name: <span class="highlight">' +
              customerName +
              "</span><br>" +
              'Phone Number: <span class="highlight">' +
              phoneNumber +
              "</span>";

            document
              .getElementById("confirmationPopup")
              .classList.add("active");
            document.getElementById("blurOverlay").classList.add("active");

            document.getElementById("confirmButton").onclick = function () {
              order.customerName = customerName;
              order.phoneNumber = phoneNumber;
              order.itemNumber = document.getElementById("itemNumber").value;
              order.color = document.getElementById("color").value;
              order.size = document.getElementById("size").value;
              order.description = document.getElementById("description").value;
              order.branch = document.querySelector(
                'input[name="branch"]:checked'
              ).value;
              order.employee = document.getElementById("employee").value;
              order.enteredBy = document.getElementById("enteredBy").value;
              order.orderDate = document.getElementById("orderDate").value;

              localStorage.setItem("orders", JSON.stringify(savedOrders));
              localStorage.removeItem("editOrderId");
              exportToExcel(savedOrders);
              window.location.href = "index.html";
            };

            document.getElementById("cancelButton").onclick = function () {
              document
                .getElementById("confirmationPopup")
                .classList.remove("active");
              document.getElementById("blurOverlay").classList.remove("active");
            };
          });

        // Preserve capitalization formatting for customer name input
        document
          .getElementById("customerName")
          .addEventListener("input", function () {
            this.value = this.value
              .split(" ")
              .map(
                (word) =>
                  word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
              )
              .join(" ");
          });
      };
      function exportToExcel(orders) {
        const fullOrders = orders.map((order) => ({
          id: order.id || "",
          orderDate: order.orderDate || "",
          customerName: order.customerName || "",
          phoneNumber: order.phoneNumber || "",
          itemNumber: order.itemNumber || "",
          color: order.color || "",
          size: order.size || "",
          description: order.description || "",
          branch: order.branch || "",
          employee: order.employee || "",
          enteredBy: order.enteredBy || "",
          status: order.status || "Pending",
          arrivalDate: order.arrivalDate || "",
          smsSent: order.smsSent || false,
        }));

        const worksheet = XLSX.utils.json_to_sheet(fullOrders);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Orders");
        XLSX.writeFile(workbook, "Orders.xlsx");
      }
    </script>
  </body>
</html>
